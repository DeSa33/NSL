name: NSL CI/CD
on:
    push:
      branches: [ "main" ]
      tags: [ "v*" ]
    pull_request:
      branches: [ "main" ]
    workflow_dispatch:
jobs:
    build:
      runs-on: ${{ matrix.os }}
      strategy:
        matrix:
          os: [ubuntu-latest, windows-latest, macos-latest]

      steps:
        - uses: actions/checkout@v4

        - name: Setup .NET
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: '8.0.x'

        - name: Restore dependencies
          run: dotnet restore

        - name: Build
          run: dotnet build --configuration Release --no-restore

        - name: Test
          run: dotnet test --no-build --configuration Release --verbosity normal

        - name: Publish
          if: matrix.os == 'ubuntu-latest'
          run: |
            dotnet publish -c Release -r linux-x64 --self-contained -o publish/linux-x64
            dotnet publish -c Release -r win-x64 --self-contained -o publish/win-x64
            dotnet publish -c Release -r osx-x64 --self-contained -o publish/osx-x64

        - name: Upload artifacts
          if: matrix.os == 'ubuntu-latest'
          uses: actions/upload-artifact@v4
          with:
            name: nsl-binaries
            path: publish/

    release:
      needs: build
      runs-on: ubuntu-latest
      if: startsWith(github.ref, 'refs/tags/v')

      steps:
        - name: Download artifacts
          uses: actions/download-artifact@v4
          with:
            name: nsl-binaries
            path: publish/

        - name: Create archives
          run: |
            cd publish
            tar -czf nsl-linux-x64.tar.gz linux-x64/
            zip -r nsl-win-x64.zip win-x64/
            tar -czf nsl-osx-x64.tar.gz osx-x64/

        - name: Create Release
          uses: softprops/action-gh-release@v1
          with:
            files: |
              publish/nsl-linux-x64.tar.gz
              publish/nsl-win-x64.zip
              publish/nsl-osx-x64.tar.gz
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
