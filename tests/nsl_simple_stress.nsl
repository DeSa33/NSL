# ============================================================
# NSL SIMPLE STRESS TEST
# Tests all major NSL subsystems without complex conversions
# ============================================================

fn bar(title) {
  print("\n" + ("=" * 60))
  print(title)
  print("=" * 60)
}

fn ok(msg) { print("✓ " + msg) }
fn info(msg) { print("ℹ " + msg) }
fn warn(msg) { print("⚠ " + msg) }

# ------------------------------------------------------------
bar("0) Environment")
# ------------------------------------------------------------

print("user:", env.user())
print("os:", env.os())
print("arch:", env.arch())
print("home:", env.home())
ok("env namespace OK")

# ------------------------------------------------------------
bar("1) JSON / YAML")
# ------------------------------------------------------------

let sample = { name: "NSL", version: "1.0", active: true }
let j = json.stringify(sample)
let jp = json.parse(j)
if (jp.name == "NSL") { ok("json OK") } else { warn("json mismatch") }

let y = yaml.stringify(sample)
let yp = yaml.parse(y)
if (yp.name == "NSL") { ok("yaml OK") } else { warn("yaml mismatch") }

# ------------------------------------------------------------
bar("2) String operations")
# ------------------------------------------------------------

let s = "  Hello World  "
let trimmed = string.trim(s)
let upper = string.upper(trimmed)
let lower = string.lower(trimmed)
let rep = "=" * 20
print("trim:", trimmed)
print("upper:", upper)
print("lower:", lower)
print("repeat:", rep)
ok("string namespace OK")

# ------------------------------------------------------------
bar("3) File operations")
# ------------------------------------------------------------

let testdir = path.join(env.home(), ".nsl", "stress_test")
dir.create(testdir)
let testfile = path.join(testdir, "test.txt")
file.write(testfile, "line1\nline2\nline3")
let content = file.read(testfile)
print("file content length:", len(content))
ok("file namespace OK")

# ------------------------------------------------------------
bar("4) Crypto")
# ------------------------------------------------------------

let uuid = crypto.uuid()
let hash = crypto.hash("sha256", "test")
print("uuid:", uuid)
print("hash:", hash)
ok("crypto namespace OK")

# ------------------------------------------------------------
bar("5) Template")
# ------------------------------------------------------------

let tmpl = "Hello ${name}, version ${ver}"
let rendered = template.render(tmpl, { name: "NSL", ver: "1.0" })
print("rendered:", rendered)
ok("template namespace OK")

# ------------------------------------------------------------
bar("6) Git")
# ------------------------------------------------------------

let isrepo = git.isRepo()
print("git.isRepo:", isrepo)
if (isrepo) {
  print("branch:", git.branch())
}
ok("git namespace OK")

# ------------------------------------------------------------
bar("7) Net")
# ------------------------------------------------------------

print("isOnline:", net.isOnline())
print("localIp:", net.localIp())
ok("net namespace OK")

# ------------------------------------------------------------
bar("8) Proc")
# ------------------------------------------------------------

let procs = proc.list()
print("process count:", len(procs))
ok("proc namespace OK")

# ------------------------------------------------------------
bar("9) Sys")
# ------------------------------------------------------------

let r = sys.exec("echo hello")
print("sys.exec result:", r.stdout)
let sh = sys.shell("echo world")
print("sys.shell result:", sh)
ok("sys namespace OK")

# ------------------------------------------------------------
bar("10) Clipboard")
# ------------------------------------------------------------

clip.copy("NSL test")
let pasted = clip.paste()
print("clipboard:", pasted)
ok("clip namespace OK")

# ------------------------------------------------------------
bar("11) Math")
# ------------------------------------------------------------

print("sqrt(16):", math.sqrt(16))
print("sin(0):", math.sin(0))
print("abs(-5):", math.abs(-5))
print("random:", math.random())
ok("math namespace OK")

# ------------------------------------------------------------
bar("12) Diff")
# ------------------------------------------------------------

let old = "alpha\nbeta\ngamma"
let new = "alpha\nBETA\ngamma"
let d = diff.lines(old, new)
print("diff result:", d)
ok("diff namespace OK")

# ------------------------------------------------------------
bar("13) List operations")
# ------------------------------------------------------------

let nums = [5, 2, 8, 1, 9]
print("sum:", list.sum(nums))
print("avg:", list.avg(nums))
print("min:", list.min(nums))
print("max:", list.max(nums))
print("sorted:", list.sort(nums))
ok("list namespace OK")

# ------------------------------------------------------------
bar("14) Regex")
# ------------------------------------------------------------

let text = "hello123world456"
let matches = regex.matches(text, "\\d+")
print("regex matches:", matches)
ok("regex namespace OK")

# ------------------------------------------------------------
bar("15) Date")
# ------------------------------------------------------------

print("now:", date.now())
print("utc:", date.utc())
ok("date namespace OK")

# ------------------------------------------------------------
bar("16) Training loop simulation")
# ------------------------------------------------------------

let weights = [0.1, 0.2, 0.3, 0.4]
let lr = 0.01
let epoch = 0
while (epoch < 3) {
  let loss = math.random()
  weights[0] = weights[0] - lr * loss
  print("epoch", epoch, "loss:", loss)
  epoch = epoch + 1
}
ok("training loop OK")

# ------------------------------------------------------------
bar("17) Report generation")
# ------------------------------------------------------------

let report = {
  user: env.user(),
  os: env.os(),
  weights: weights,
  timestamp: date.now()
}
let reportpath = path.join(testdir, "report.json")
file.write(reportpath, json.stringify(report))
ok("Report written to: " + reportpath)

bar("ALL TESTS COMPLETE")
print("\nNSL stress test passed!")
