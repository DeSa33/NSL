// Test Mutable Closures in NSL
print("=== Testing Mutable Closures ===")
print("")

// Test 1: Counter (stateful closure)
print("-- Test 1: Counter --")

fn makeCounter(start) {
    let count = start
    fn increment() {
        count = count + 1
        return count
    }
    return increment
}

let counter = makeCounter(0)
print("counter() =", counter())  // Should be 1
print("counter() =", counter())  // Should be 2
print("counter() =", counter())  // Should be 3
print("")

// Test 2: Accumulator
print("-- Test 2: Accumulator --")

fn makeAccumulator(initial) {
    let total = initial
    fn add(amount) {
        total = total + amount
        return total
    }
    return add
}

let acc = makeAccumulator(0)
print("acc(10) =", acc(10))  // Should be 10
print("acc(5) =", acc(5))    // Should be 15
print("acc(3) =", acc(3))    // Should be 18
print("")

// Test 3: Multiple closures sharing state
print("-- Test 3: Shared State --")

fn makePair() {
    let value = 0

    fn getter() {
        return value
    }

    fn setter(x) {
        value = x
        return value
    }

    return [getter, setter]
}

let pair = makePair()
let get = pair[0]
let set = pair[1]

print("Initial value:", get())  // Should be 0
set(42)
print("After set(42):", get())  // Should be 42
set(100)
print("After set(100):", get())  // Should be 100
print("")

// Test 4: Nested closures
print("-- Test 4: Nested Closures --")

fn outer(x) {
    fn middle(y) {
        fn inner(z) {
            return x + y + z
        }
        return inner
    }
    return middle
}

let step1 = outer(1)
let step2 = step1(2)
let result = step2(3)
print("outer(1)(2)(3) =", result)  // Should be 6
print("")

// Test 5: Short-circuit evaluation
print("-- Test 5: Short-Circuit Evaluation --")

fn dangerous() {
    print("This should NOT print if short-circuit works")
    return true
}

let x = false and dangerous()  // Should not call dangerous()
print("false and dangerous() =", x)

let y = true or dangerous()  // Should not call dangerous()
print("true or dangerous() =", y)
print("")

// Test 6: Array with index check (uses short-circuit)
print("-- Test 6: Safe Array Access --")

let arr = [10, 20, 30]
let idx = -1

// This should not cause an error due to short-circuit
if (idx >= 0 and arr[idx] > 0) {
    print("Found positive value at index", idx)
} else {
    print("Index out of bounds or no positive value")
}

idx = 1
if (idx >= 0 and arr[idx] > 0) {
    print("Found positive value", arr[idx], "at index", idx)
}
print("")

print("=== All Closure Tests Complete ===")
